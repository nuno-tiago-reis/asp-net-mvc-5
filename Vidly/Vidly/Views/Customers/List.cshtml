@{
	ViewBag.Title = "Customers";
	Layout = "~/Views/Shared/_Layout.cshtml";
}

<input type="button" class="btn btn-primary" value="Create" onclick="location.href='@Url.Action("Create", "Customers")'" />

<br />
<br />

<table id="customers" class="table table-bordered table-hover">
	<thead>
		<tr>
			<th>Customer</th>
			<th>Membership</th>
			<th>Discount Rate</th>
			<th>Delete?</th>
		</tr>
	</thead>
	<tbody />
</table>

@section scripts
{
	<script>
		$(document).ready(function ()
		{
			var table = $("#customers").DataTable
			({
				ajax:
				{
					url: "/api/customers",
					dataSrc: ""
				},
				columns:
				[
					{
						render: function (data, type, customer)
						{
							return "<a href='/customers/edit/" + customer.id + "'>" + customer.name + "</a>";
						}
					},
					{
						data: "membershipType.name"
					},
					{
						data: "membershipType.discountRate"
					},
					{
						render: function (data, type, customer)
						{
							return "<button class='btn btn-danger js-delete' data-customer-id='" + customer.id + "'>Delete</button>";
						}
					}
				],
				"drawCallback": function ()
				{
					$('[data-toggle="tooltip"]').tooltip();
				}
			});

			$("#customers").on("click", ".js-delete", function ()
			{
				var button = $(this);

				bootbox.confirm("Are you sure you want to delete this customer?", function (result)
				{
					if (result)
					{
						$.ajax
						({
							url: "/api/customers/" + button.attr("data-customer-id"),
							method: "DELETE",

							success: function ()
							{
								table.row(button.parents("tr")).remove().draw();
								toastr.success("Customer successfully deleted.");
							},

							error: function(xhr)
							{
								var error = JSON.parse(xhr.responseText);
								toastr.error("An error occurred:" + error.message);
							}
						});
					}
				});
			});
		});
	</script>
}